<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Stock Watchlist</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
  background:#0f172a;
  color:#e5e7eb;
}

header{
  background:rgba(15,23,42,0.9);
  backdrop-filter: blur(12px);
  border-bottom:1px solid #1e293b;
  padding:16px 28px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

header strong{
  font-size:20px;
  font-weight:700;
  letter-spacing:.3px;
}

nav{
  display:flex;
  gap:10px;
}

nav button{
  background:#1e293b;
  border:none;
  color:#cbd5f5;
  font-size:14px;
  padding:8px 16px;
  border-radius:999px;
  cursor:pointer;
  transition:.25s;
}

nav button:hover{
  background:#334155;
}

nav button.active{
  background:#2563eb;
  color:white;
}

button{
  background:#2563eb;
  color:white;
  border:none;
  border-radius:8px;
  padding:10px 16px;
  cursor:pointer;
  transition:.2s;
}

button:hover{transform:translateY(-1px)}

.app-wrap{
  max-width:1300px;
  margin:auto;
  padding:28px;
}

.search-card{
  background:#020617;
  border-radius:14px;
  padding:18px;
  border:1px solid #1e293b;
  position:relative;
}

.search-input{
  width:100%;
  padding:14px;
  border-radius:10px;
  border:1px solid #334155;
  background:#020617;
  color:#e5e7eb;
  font-size:15px;
}

.dropdown{
  position:absolute;
  left:18px;
  right:18px;
  top:68px;
  background:#020617;
  border:1px solid #334155;
  border-radius:10px;
  max-height:240px;
  overflow-y:auto;
  z-index:999;
}

.option{
  padding:10px 14px;
  cursor:pointer;
  font-size:14px;
}

.option:hover{background:#1e293b}

.stock-grid{
  margin-top:24px;
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
  gap:20px;
}

.stock-card{
  background:#020617;
  border-radius:16px;
  padding:18px;
  border:1px solid #1e293b;
  transition:.25s;
}

.stock-card:hover{
  transform:translateY(-4px);
  box-shadow:0 0 0 1px #2563eb;
}

.stock-title{
  font-weight:600;
  font-size:15px;
}

.price{
  font-size:28px;
  font-weight:700;
  margin:6px 0;
}

.green{color:#22c55e}
.red{color:#ef4444}

.alert-card{
  background:#020617;
  padding:22px;
  border-radius:18px;
  border:1px solid #1e293b;
}

.alert-row{
  display:grid;
  grid-template-columns:1fr 1fr 1fr 2fr 2fr 50px;
  gap:10px;
  align-items:center;
  border-bottom:1px solid #1e293b;
  padding:10px 0;
}

.alert-chip{
  background:#1e293b;
  color:#60a5fa;
  padding:6px 14px;
  border-radius:999px;
  font-weight:600;
  font-size:13px;
}
</style>
</head>

<body>

<div id="loginScreen" class="login-wrap">
  <div class="login-card">
    <h2>Login / Sign Up</h2>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button id="loginBtn">Login</button>
    <button id="signupBtn">Sign Up</button>
  </div>
</div>

<div id="appScreen" style="display:none">
<header>
  <div>
    <strong>ðŸ“ˆ Stock Watchlist</strong>
    <nav>
      <button id="tabWatch" class="active">Watchlist</button>
      <button id="tabAlerts">Alerts</button>
    </nav>
  </div>
  <button id="logoutBtn">Logout</button>
</header>

<div class="app-wrap">

<div id="watchTab">
  <div class="search-card">
    <input id="search" class="search-input" placeholder="Search stock...">
    <div id="dropdown" class="dropdown"></div>
  </div>
  <div id="stockGrid" class="stock-grid"></div>
</div>

<div id="alertsTab" style="display:none">
  <div class="alert-card">
    <h3>ðŸ”” Price Alerts</h3>

    <div style="display:flex;gap:10px;margin-bottom:14px">
      <select id="alertSymbol" style="flex:1;padding:10px"></select>
      <input id="alertPrice" type="number" placeholder="Target Price" style="flex:1;padding:10px">
      <button id="addAlertBtn">Add</button>
    </div>

    <div id="alertList"></div>
  </div>
</div>

</div>
</div>

<!-- EMAILJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
  emailjs.init("-nPbEj5p827UiuqEA");
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, deleteDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyCd2vJNlGVh9q1GWT2M_GepSKolo-t2Sr4",
  authDomain:"stock-watchlist-app-1eced.firebaseapp.com",
  projectId:"stock-watchlist-app-1eced"
});

const auth = getAuth(app);
const db = getFirestore(app);

let allStocks=[], watchlist=[], alerts=[], userId=null;

loginBtn.onclick=()=>signInWithEmailAndPassword(auth,email.value,password.value);
signupBtn.onclick=()=>createUserWithEmailAndPassword(auth,email.value,password.value);
logoutBtn.onclick=()=>signOut(auth);

onAuthStateChanged(auth,async u=>{
  if(!u)return;
  userId=u.uid;
  loginScreen.style.display="none";
  appScreen.style.display="block";

  allStocks=await (await fetch("/api/stocks")).json();
  const snap=await getDoc(doc(db,"users",userId));
  if(snap.exists()) watchlist=snap.data().watchlist||[];

  render();
  loadAlerts();
  setInterval(render,15000);
  setInterval(checkAlerts,30000);
});

/* SEARCH */
search.addEventListener("input",e=>{
  const q=e.target.value.toLowerCase();
  dropdown.innerHTML="";
  if(!q)return;
  allStocks.filter(s=>s.name.toLowerCase().includes(q)||s.symbol.toLowerCase().includes(q))
    .slice(0,10).forEach(s=>{
      const d=document.createElement("div");
      d.className="option";
      d.textContent=`${s.name} (${s.symbol})`;
      d.onclick=()=>addStock(s);
      dropdown.appendChild(d);
    });
});

/* WATCHLIST */
async function addStock(s){
  if(watchlist.find(x=>x.symbol===s.symbol))return;
  watchlist.push(s);
  await setDoc(doc(db,"users",userId),{watchlist},{merge:true});
  dropdown.innerHTML="";search.value="";
  render();
}

async function render(){
  if(!watchlist.length)return;
  const syms=watchlist.map(s=>s.symbol).join(",");
  const data=await (await fetch(`/api/prices?symbols=${syms}`)).json();
  stockGrid.innerHTML="";
  watchlist.forEach(s=>{
    const d=data[s.symbol]; if(!d)return;
    const div=document.createElement("div");
    div.className="stock-card";
    div.innerHTML=`
      <div style="display:flex;justify-content:space-between">
        <a href="https://www.screener.in/company/${s.symbol.replace(".NS","").replace(".BO","")}/"
          target="_blank"
          style="color:#1d4ed8;text-decoration:none;font-weight:600">
          ${s.name}
        </a>
        <button onclick="removeStock('${s.symbol}')">âœ•</button>
      </div>
      <div class="price">â‚¹${d.price.toFixed(2)}</div>
      <div class="${d.change>=0?'green':'red'}">${d.changePercent.toFixed(2)}%</div>
      <div>52W H: ${d.high52} | 52W L: ${d.low52}</div>
      <div>Vol: ${d.volume.toLocaleString()}</div>`;
    stockGrid.appendChild(div);
  });
}

window.removeStock=async sym=>{
  watchlist=watchlist.filter(s=>s.symbol!==sym);
  await setDoc(doc(db,"users",userId),{watchlist},{merge:true});
  render();
};

/* ALERTS */
function populateAlertDropdown(){
  alertSymbol.innerHTML="";
  watchlist.forEach(s=>{
    const o=document.createElement("option");
    o.value=s.symbol;
    o.textContent=`${s.name} (${s.symbol})`;
    alertSymbol.appendChild(o);
  });
}

tabAlerts.onclick=()=>{
  watchTab.style.display="none";
  alertsTab.style.display="block";
  populateAlertDropdown();
  renderAlerts();
};

tabWatch.onclick=()=>{
  watchTab.style.display="block";
  alertsTab.style.display="none";
};

addAlertBtn.onclick=async ()=>{
  const s=alertSymbol.value;
  const p=+alertPrice.value;
  if(!s||!p)return alert("Fill both");
  await addDoc(collection(db,"users",userId,"alerts"),{
    symbol:s,price:p,email:auth.currentUser.email,
    triggered:false,createdAt:serverTimestamp(),triggeredAt:null
  });
  alertPrice.value="";
  loadAlerts();
};

async function loadAlerts(){
  alerts=[];
  const snap=await getDocs(collection(db,"users",userId,"alerts"));
  snap.forEach(d=>alerts.push({id:d.id,...d.data()}));
  renderAlerts();
}

function renderAlerts(){
  alertList.innerHTML="";
  alerts.forEach(a=>{
    const r=document.createElement("div");
    r.className="alert-row";
    r.innerHTML=`
      <span class="alert-chip">${a.symbol}</span>
      <span>â‚¹${a.price}</span>
      <span>${a.triggered?"Triggered":"Pending"}</span>
      <span>${a.createdAt?.toDate?.().toLocaleString()||""}</span>
      <span>${a.triggeredAt?.toDate?.().toLocaleString()||"-"}</span>
      <button>âœ•</button>`;
    r.querySelector("button").onclick=()=>deleteAlert(a.id);
    alertList.appendChild(r);
  });
}

async function deleteAlert(id){
  await deleteDoc(doc(db,"users",userId,"alerts",id));
  loadAlerts();
}

/* ðŸ”¥ AUTO CHECK + EMAILJS */
async function checkAlerts(){
  if(!alerts.length)return;
  const syms=alerts.map(a=>a.symbol).join(",");
  const data=await (await fetch(`/api/prices?symbols=${syms}`)).json();

  for(const a of alerts){
    if(a.triggered)continue;
    const d=data[a.symbol];
    if(!d)continue;

    if(d.price>=a.price){
      await emailjs.send("service_38gmuds","template_sem5vlb",{
        to_email:a.email,
        symbol:a.symbol,
        alert_price:a.price,
        current_price:d.price,
        change:d.change,
        change_percent:d.changePercent
      });

      await updateDoc(doc(db,"users",userId,"alerts",a.id),
        {triggered:true,triggeredAt:serverTimestamp()});
      loadAlerts();
    }
  }
}
</script>
</body>
</html>
